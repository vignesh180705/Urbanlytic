{% extends "base.html" %}

{% block content %}
<div id="appContainer">
    {% include "partials/header.html" %}
    {% include "partials/sidebar.html" %}

    <main class="main-panel">
        <div class="container page-container">
            <h2 class="page-title">Submit Incident Report</h2>
            <p class="page-subtitle">Provide details about the urban issue you want to report.</p>

            <form id="reportForm" class="report-form" enctype="multipart/form-data">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" name="location" placeholder="Area / landmark" required>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select name="type" required>
                            <option value="">Select type</option>
                            <option value="Accident">Accident</option>
                            <option value="Fire">Fire</option>
                            <option value="Theft">Theft</option>
                            <option value="Medical">Medical</option>
                            <option value="Traffic">Traffic</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Description</label>
                        <textarea name="description" placeholder="Detailed description of the issue" rows="4" required></textarea>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Media (Image / Video)</label>
                        <input type="file" name="media" accept="image/*,video/*" id="mediaInput">
                        <div id="mediaPreview" style="margin-top: 10px;"></div>
                    </div>
                </div>
                <div id="submitResult" style="margin-top: 15px;"></div>
                <button type="submit" class="submit-btn">Submit Report</button>
            </form>

    </main>
</div>

<script>
    document.getElementById("reportForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        const res = await fetch("{{ url_for('submit_report') }}", {
            method: "POST",
            body: formData
        });

        const result = await res.json();
        const msgDiv = document.getElementById("submitResult");

        if(result.status === "success"){
            msgDiv.innerHTML = `<p style="color:lightGreen;">Report submitted successfully! ID: ${result.incident_id}</p>`;
            console.log("Submitted Report:", result.report);
            this.reset(); // Reset form fields
            mediaPreview.innerHTML = ""; // Clear media preview
        } else {
            msgDiv.innerHTML = `<p style="color:#ff4b2b;">Error: ${result.detail}</p>`;
        }

        // Scroll to message for better UX
        msgDiv.scrollIntoView({ behavior: "smooth" });
    });
</script>

<script>
    const mediaInput = document.getElementById("mediaInput");
    const mediaPreview = document.getElementById("mediaPreview");

    mediaInput.addEventListener("change", function() {
        mediaPreview.innerHTML = ""; // Clear previous preview
        const file = this.files[0];
        if(!file) return;

        if(file.type.startsWith("image/")) {
            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.style.maxWidth = "300px";
            img.style.maxHeight = "200px";
            img.style.borderRadius = "8px";
            mediaPreview.appendChild(img);
        } else if(file.type.startsWith("video/")) {
            const video = document.createElement("video");
            video.src = URL.createObjectURL(file);
            video.controls = true;
            video.style.maxWidth = "300px";
            video.style.maxHeight = "200px";
            video.style.borderRadius = "8px";
            mediaPreview.appendChild(video);
        }
    });
</script>
{% endblock %}
