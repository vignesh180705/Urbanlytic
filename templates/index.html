<!DOCTYPE html>
<html>
<head>
    <title>Urbanlytic - Incident Reports</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .incident-card {
            border: 1px solid #ccc;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .category { font-weight: bold; color: #2c3e50; }
        .summary { font-style: italic; color: #555; }
        .meta { font-size: 0.9em; color: #777; }
    </style>
</head>
<body>
    <h2>Submit Incident Report</h2>
    <form id="incidentForm">
        <input type="text" name="user_id" placeholder="User ID" required><br><br>
        <textarea name="description" placeholder="Description" required></textarea><br><br>
        <input type="text" name="location" placeholder="Location" required><br><br>
        <button type="submit">Submit</button>
    </form>
    <hr>
    <h2>Incoming Messages</h2>
    <div id="messages"></div>

<script>
    function renderIncident(incident) {
        const div = document.createElement("div");
        div.className = "incident-card";
        div.innerHTML = `
            <div class="category">üìå ${incident.category || "Uncategorized"}</div>
            <div class="summary">"${incident.summary || incident.description}"</div>
            <div class="meta">
                üë§ User: ${incident.user_id} <br>
                üìç Location: ${incident.location} <br>
                ‚è∞ ${incident.timestamp || ""}
            </div>
        `;
        return div;
    }

    // Fetch last 10 incidents on load
    async function loadHistory() {
        const res = await fetch("/history");
        const data = await res.json();
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = ""; // clear old
        data.incidents.reverse().forEach(incident => {
            messagesDiv.appendChild(renderIncident(incident));
        });
    }
    loadHistory();

    // WebSocket for live updates
    const ws = new WebSocket("ws://" + window.location.host + "/ws");
    ws.onmessage = (event) => {
        const incident = JSON.parse(event.data);
        document.getElementById("messages").prepend(renderIncident(incident));
    };

    // Submit form
    document.getElementById("incidentForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        const res = await fetch("/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
        if (res.ok) {
            e.target.reset();
        } else {
            alert("Error submitting report");
        }
    });
</script>

</body>
</html>
